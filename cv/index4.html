<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scrollable PDF Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Use Poppins to match the siteâ€™s typography -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap">

  <!-- Include PDF.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.5.141/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.5.141/pdf.worker.min.js';
  </script>

  <style>
    :root {
      --primary-color: #795548;
      --primary-hover: #49332b;
      --background-color: #f8f9fa;
      --text-color: #212529;
      --sidebar-width: 220px;
      --toolbar-height: 50px;
      --outline-font-size: 0.8rem;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      overflow: hidden;
    }

    /* Toolbar styling */
    #toolbar {
      display: flex;
      align-items: center;
      height: var(--toolbar-height);
      padding: 0 10px;
      background-color: var(--primary-color);
      color: #fff;
      z-index: 100;
    }
    #toolbar button,
    #toolbar input,
    #toolbar span {
      margin-right: 8px;
    }
    #toolbar button {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    #toolbar button:hover {
      background-color: var(--primary-hover);
    }
    #toolbar input[type="number"] {
      width: 60px;
      padding: 4px;
      border-radius: 4px;
      border: none;
    }
    #toolbar input[type="text"] {
      padding: 4px 6px;
      border-radius: 4px;
      border: none;
      width: 200px;
    }
    #search_info {
      font-size: 14px;
    }

    /* Layout wrapper */
    #container {
      display: flex;
      height: calc(100vh - var(--toolbar-height));
      overflow: hidden;
    }

    /* Sidebar with tabs for outline and thumbnails */
    #sidebar {
      width: var(--sidebar-width);
      background-color: #fff;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }
    #sidebar.collapsed {
      transform: translateX(calc(-1 * var(--sidebar-width)));
    }
    #sidebarTabs {
      display: flex;
      justify-content: space-around;
      border-bottom: 1px solid #ddd;
      background-color: var(--background-color);
      padding: 5px 0;
    }
    #sidebarTabs button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--primary-color);
    }
    #sidebarTabs button.active {
      color: var(--primary-hover);
    }
    /* Content areas inside sidebar */
    .sidebar-content {
      display: none;
      padding: 8px;
    }
    .sidebar-content.active {
      display: block;
    }
    /* Outline file tree */
    #outlineList {
      list-style: none;
      padding-left: 0;
      font-size: var(--outline-font-size);
    }
    #outlineList li {
      cursor: pointer;
      margin: 4px 0;
    }
    #outlineList li:hover {
      text-decoration: underline;
    }
    /* Indent nested outlines */
    #outlineList .level-1 { margin-left: 10px; }
    #outlineList .level-2 { margin-left: 20px; }
    #outlineList .level-3 { margin-left: 30px; }

    /* Thumbnails */
    #thumbsList {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .thumb-item {
      margin-bottom: 10px;
      text-align: center;
      cursor: pointer;
      position: relative;
      width: 90px;
      margin-left: auto;
      margin-right: auto;
    }
    .thumb-item canvas {
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .thumb-item.active canvas {
      border-color: var(--primary-color);
    }
    .thumb-item .page-label {
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      font-size: 12px;
      padding: 1px 4px;
      border-radius: 2px;
      pointer-events: none;
    }

    /* Viewer container: holds all pages, scrollable */
    #viewerContainer {
      flex-grow: 1;
      overflow-y: auto;
      position: relative;
      padding: 10px;
    }
    .pdf-page {
      position: relative;
      margin-bottom: 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      background-color: #fff;
    }
    .pdf-page canvas.pdfCanvas {
      width: 100%;
      height: auto;
      display: block;
    }
    .pdf-page canvas.hlCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="toggleSidebar">&#9776;</button>
    <button id="prev">&#8592;</button>
    <button id="next">&#8594;</button>
    <span>Page <input type="number" id="page_num" min="1"> / <span id="page_count">--</span></span>
    <button id="zoom_out">&#8722;</button>
    <button id="zoom_in">&#43;</button>
    <button id="fit_width" title="Fit to width">&#8596;</button>
    <button id="fit_page" title="Fit to page">&#8597;</button>
    <input type="text" id="search_input" placeholder="Search...">
    <button id="search_btn">Search</button>
    <span id="search_info"></span>
    <!-- Rotate controls -->
    <button id="rotate_left" title="Rotate left">&#8634;</button>
    <button id="rotate_right" title="Rotate right">&#8635;</button>
    <button id="downloadBtn" title="Download">&#10515;</button>
    <button id="fullscreenBtn" title="Fullscreen">&#x26F6;</button>
  </div>
  <div id="container">
    <div id="sidebar" class="collapsed">
      <div id="sidebarTabs">
        <button id="outlineToggle" title="Outline">&#128196;</button>
        <button id="thumbToggle" title="Thumbnails">&#128247;</button>
      </div>
      <div id="outlineList" class="sidebar-content"></div>
      <div id="thumbsList" class="sidebar-content"></div>
    </div>
    <div id="viewerContainer"></div>
  </div>

  <script>
    let pdfDoc = null;
    let pages = [];
    let scale = 1.0;
    let currentQuery = '';
    let rotation = 0;
    // Debounce timer for search
    let searchTimeout = null;
    // Thumbnails cache
    const thumbCache = {};

    // Default PDF: change or override via ?file=
    const DEFAULT_URL = 'sample.pdf';

    /**
     * Calculate an appropriate scale factor so the pages fit within the
     * available viewer width.  We use the width of the first page as reference.
     */
    async function computeScaleForWidth(page) {
      const container = document.getElementById('viewerContainer');
      const containerWidth = container.clientWidth - 20; // account for padding
      const viewport = page.getViewport({ scale: 1.0, rotation: rotation });
      return containerWidth / viewport.width;
    }

    /**
     * Render all pages of the document at the current scale.  Creates
     * individual page containers with a PDF canvas and a separate highlight
     * canvas on top.  Stores each page's text content for later search.
     */
    async function renderAllPages() {
      const viewer = document.getElementById('viewerContainer');
      viewer.innerHTML = '';
      pages = [];
      const firstPage = await pdfDoc.getPage(1);
      scale = await computeScaleForWidth(firstPage);
      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: scale, rotation: rotation });
        // Create page container
        const pageDiv = document.createElement('div');
        pageDiv.classList.add('pdf-page');
        pageDiv.setAttribute('data-page-number', i);
        // Create canvases
        const canvas = document.createElement('canvas');
        canvas.classList.add('pdfCanvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const context = canvas.getContext('2d');
        // Highlight canvas
        const hlCanvas = document.createElement('canvas');
        hlCanvas.classList.add('hlCanvas');
        hlCanvas.width = viewport.width;
        hlCanvas.height = viewport.height;
        const hlContext = hlCanvas.getContext('2d');
        // Append canvases
        pageDiv.appendChild(canvas);
        pageDiv.appendChild(hlCanvas);
        viewer.appendChild(pageDiv);
        // Render PDF page
        page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
          // After rendering, highlight if query
          if (currentQuery) {
            highlightPage(i);
          }
        });
        // Get text content for search/highlight
        const textContent = await page.getTextContent();
        pages.push({ page, viewport, canvas, context, hlCanvas, hlContext, textContent });
      }
      // Generate thumbnails and outline after rendering
      generateThumbnails();
      populateOutline();
      document.getElementById('page_count').textContent = pdfDoc.numPages;
      document.getElementById('page_num').max = pdfDoc.numPages;
    }

    /**
     * Highlight search matches on a particular page.  Clears previous
     * highlights on that page's highlight canvas and draws semi-transparent
     * rectangles where the query appears.
     */
    function highlightPage(pageIndex) {
      if (!currentQuery) return;
      const pageObj = pages[pageIndex - 1];
      const { textContent, hlCanvas, hlContext, viewport } = pageObj;
      // Clear previous highlights
      hlContext.clearRect(0, 0, hlCanvas.width, hlCanvas.height);
      const query = currentQuery.toLowerCase();
      const items = textContent.items;
      items.forEach(item => {
        const text = item.str;
        if (!text) return;
        const lowerText = text.toLowerCase();
        let startIndex = 0;
        while (true) {
          const idx = lowerText.indexOf(query, startIndex);
          if (idx === -1) break;
          // Compute highlight box
          const transform = pdfjsLib.Util.transform(viewport.transform, item.transform);
          const x = transform[4];
          // y coordinate: PDF.js defines transform[5] as baseline; adjust by height
          const y = transform[5] - item.height * scale;
          // width per character
          const charWidth = (item.width * scale) / text.length;
          const highlightWidth = charWidth * query.length;
          const highlightX = x + charWidth * idx;
          const highlightY = y;
          const highlightHeight = item.height * scale;
          hlContext.fillStyle = 'rgba(255, 255, 0, 0.4)';
          hlContext.fillRect(highlightX, highlightY, highlightWidth, highlightHeight);
          startIndex = idx + query.length;
        }
      });
    }

    /**
     * Apply highlights across all pages based on currentQuery.  Called after
     * performing a search.
     */
    function highlightAllPages() {
      if (!currentQuery) {
        // Clear all highlight canvases
        pages.forEach(p => p.hlContext.clearRect(0, 0, p.hlCanvas.width, p.hlCanvas.height));
        return;
      }
      pages.forEach((p, index) => {
        highlightPage(index + 1);
      });
    }

    /**
     * Perform a search across the document.  Counts pages containing the
     * query and then highlights all occurrences.
     */
    async function performSearch(query) {
      currentQuery = query.trim().toLowerCase();
      const infoEl = document.getElementById('search_info');
      if (!currentQuery) {
        infoEl.textContent = '';
        highlightAllPages();
        return;
      }
      let pagesWithMatch = 0;
      let totalMatches = 0;
      for (const pageObj of pages) {
        const itemsText = pageObj.textContent.items.map(it => it.str).join(' ').toLowerCase();
        if (itemsText.includes(currentQuery)) {
          pagesWithMatch++;
        }
        // Count occurrences per page
        let startIdx = 0;
        while (true) {
          const idx = itemsText.indexOf(currentQuery, startIdx);
          if (idx === -1) break;
          totalMatches++;
          startIdx = idx + currentQuery.length;
        }
      }
      infoEl.textContent = `${totalMatches} result${totalMatches !== 1 ? 's' : ''} in ${pagesWithMatch} page${pagesWithMatch !== 1 ? 's' : ''}`;
      highlightAllPages();
    }

    /**
     * Generate thumbnails in the sidebar.  Each thumbnail is scaled down and
     * displays its page number below the image.  Clicking navigates to the
     * corresponding page by scrolling.
     */
    function generateThumbnails() {
      const thumbsContainer = document.getElementById('thumbsList');
      thumbsContainer.innerHTML = '';
      pages.forEach((pageObj, idx) => {
        const i = idx + 1;
        const thumbItem = document.createElement('div');
        thumbItem.classList.add('thumb-item');
        if (i === 1) thumbItem.classList.add('active');
        // Thumbnail canvas
        const canvas = document.createElement('canvas');
        canvas.width = 80;
        canvas.height = 100;
        const ctxThumb = canvas.getContext('2d');
        thumbItem.appendChild(canvas);
        // Page number overlay
        const label = document.createElement('div');
        label.classList.add('page-label');
        label.textContent = i;
        thumbItem.appendChild(label);
        // Render thumbnail
        if (thumbCache[i]) {
          ctxThumb.drawImage(thumbCache[i], 0, 0, canvas.width, canvas.height);
        } else {
          const { page } = pageObj;
        const viewport = page.getViewport({ scale: 0.2, rotation: rotation });
          const tmpCanvas = document.createElement('canvas');
          tmpCanvas.width = viewport.width;
          tmpCanvas.height = viewport.height;
          const tmpCtx = tmpCanvas.getContext('2d');
          page.render({ canvasContext: tmpCtx, viewport: viewport }).promise.then(() => {
            thumbCache[i] = tmpCanvas;
            ctxThumb.drawImage(tmpCanvas, 0, 0, canvas.width, canvas.height);
          });
        }
        // Click event: scroll to page
        thumbItem.addEventListener('click', () => {
          const targetDiv = document.querySelector(`.pdf-page[data-page-number="${i}"]`);
          targetDiv.scrollIntoView({ behavior: 'smooth' });
          updateActiveThumbnail(i);
          // update page number input
          document.getElementById('page_num').value = i;
        });
        thumbsContainer.appendChild(thumbItem);
      });
    }
    function updateActiveThumbnail(current) {
      const items = document.querySelectorAll('.thumb-item');
      items.forEach((item, idx) => {
        item.classList.toggle('active', idx + 1 === current);
      });
    }

    /**
     * Populate the outline as a nested list up to 3 levels deep.  Each item
     * scrolls to the corresponding page when clicked.
     */
    async function populateOutline() {
      const outline = await pdfDoc.getOutline();
      const container = document.getElementById('outlineList');
      container.innerHTML = '';
      function addItems(items, parent, level) {
        if (!items || level > 3) return;
        items.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item.title;
          li.classList.add(`level-${level}`);
          li.addEventListener('click', async () => {
            if (item.dest) {
              const dest = await pdfDoc.getDestination(item.dest);
              const pageIndex = (await pdfDoc.getPageIndex(dest[0])) + 1;
              const target = document.querySelector(`.pdf-page[data-page-number="${pageIndex}"]`);
              if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
                updateActiveThumbnail(pageIndex);
                document.getElementById('page_num').value = pageIndex;
              }
            } else if (item.url) {
              window.open(item.url, '_blank');
            }
          });
          parent.appendChild(li);
          if (item.items) addItems(item.items, parent, level + 1);
        });
      }
      addItems(outline, container, 1);
    }

    /**
     * Determine file parameter from query string.
     */
    function getQueryParameter(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    /**
     * Load a PDF document from URL and initialise viewer.
     */
    function loadPdf(url) {
      pdfjsLib.getDocument(url).promise.then(async pdf => {
        pdfDoc = pdf;
        await renderAllPages();
        setDownloadLink(url);
        // Scroll to first page
        document.getElementById('page_num').value = 1;
      }).catch(err => {
        console.error('Error loading PDF:', err);
      });
    }

    /**
     * Set up the download link for the document.
     */
    function setDownloadLink(url) {
      document.getElementById('downloadBtn').onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        a.download = url.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      };
    }

    /**
     * Adjust the scale to fit the page width or height and re-render all pages.
     */
    async function fitToWidth() {
      if (!pdfDoc) return;
      const firstPage = await pdfDoc.getPage(1);
      const newScale = await computeScaleForWidth(firstPage);
      scale = newScale;
      await renderAllPages();
      highlightAllPages();
    }
    async function fitToPage() {
      if (!pdfDoc) return;
      const containerHeight = document.getElementById('viewerContainer').clientHeight - 20;
      const firstPage = await pdfDoc.getPage(1);
      const viewport = firstPage.getViewport({ scale: 1.0, rotation: rotation });
      const newScale = containerHeight / viewport.height;
      scale = newScale;
      await renderAllPages();
      highlightAllPages();
    }

    // Navigation via Prev/Next buttons
    function goToPrev() {
      const current = parseInt(document.getElementById('page_num').value) || 1;
      if (current > 1) {
        const newPage = current - 1;
        document.getElementById('page_num').value = newPage;
        const target = document.querySelector(`.pdf-page[data-page-number="${newPage}"]`);
        if (target) target.scrollIntoView({ behavior: 'smooth' });
        updateActiveThumbnail(newPage);
      }
    }
    function goToNext() {
      const current = parseInt(document.getElementById('page_num').value) || 1;
      if (current < pages.length) {
        const newPage = current + 1;
        document.getElementById('page_num').value = newPage;
        const target = document.querySelector(`.pdf-page[data-page-number="${newPage}"]`);
        if (target) target.scrollIntoView({ behavior: 'smooth' });
        updateActiveThumbnail(newPage);
      }
    }

    /**
     * Event listeners
     */
    document.getElementById('toggleSidebar').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('collapsed');
    });
    document.getElementById('outlineToggle').addEventListener('click', () => {
      document.getElementById('outlineToggle').classList.add('active');
      document.getElementById('thumbToggle').classList.remove('active');
      document.getElementById('outlineList').classList.add('active');
      document.getElementById('thumbsList').classList.remove('active');
    });
    document.getElementById('thumbToggle').addEventListener('click', () => {
      document.getElementById('thumbToggle').classList.add('active');
      document.getElementById('outlineToggle').classList.remove('active');
      document.getElementById('thumbsList').classList.add('active');
      document.getElementById('outlineList').classList.remove('active');
    });
    // Set default active tab: outline
    document.getElementById('outlineToggle').classList.add('active');
    document.getElementById('outlineList').classList.add('active');
    document.getElementById('thumbToggle').classList.remove('active');
    document.getElementById('thumbsList').classList.remove('active');

    document.getElementById('prev').addEventListener('click', goToPrev);
    document.getElementById('next').addEventListener('click', goToNext);
    document.getElementById('zoom_in').addEventListener('click', async () => {
      scale *= 1.25;
      await renderAllPages();
      highlightAllPages();
    });
    document.getElementById('zoom_out').addEventListener('click', async () => {
      scale /= 1.25;
      await renderAllPages();
      highlightAllPages();
    });
    document.getElementById('fit_width').addEventListener('click', fitToWidth);
    document.getElementById('fit_page').addEventListener('click', fitToPage);
    document.getElementById('search_btn').addEventListener('click', () => {
      performSearch(document.getElementById('search_input').value);
    });
    document.getElementById('search_input').addEventListener('keypress', e => {
      if (e.key === 'Enter') performSearch(e.target.value);
    });
    // Real-time search: debounce input events
    document.getElementById('search_input').addEventListener('input', () => {
      const value = document.getElementById('search_input').value;
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        performSearch(value);
      }, 300);
    });
    document.getElementById('page_num').addEventListener('change', () => {
      const val = parseInt(document.getElementById('page_num').value);
      if (!val || val < 1 || val > pages.length) return;
      const target = document.querySelector(`.pdf-page[data-page-number="${val}"]`);
      if (target) target.scrollIntoView({ behavior: 'smooth' });
      updateActiveThumbnail(val);
    });
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    });

    // Rotation controls
    document.getElementById('rotate_left').addEventListener('click', async () => {
      rotation = (rotation - 90 + 360) % 360;
      await renderAllPages();
      highlightAllPages();
    });
    document.getElementById('rotate_right').addEventListener('click', async () => {
      rotation = (rotation + 90) % 360;
      await renderAllPages();
      highlightAllPages();
    });

    // Determine file parameter
    const fileParam = getQueryParameter('file');
    if (fileParam) {
      loadPdf(fileParam);
    } else {
      loadPdf(DEFAULT_URL);
    }
  </script>
</body>
</html>